<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <title>견적서 작성</title>
    <style>
body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f7fa;
    color: #333;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

.container {
    width: 100%;
    max-width: 1000px;
    padding: 20px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    text-align: center;
    margin: 20px;
}

h1 {
    font-size: 24px;
    color: #34495e;
    margin-bottom: 20px;
}

.action-button, .select-button {
    padding: 14px 20px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    margin: 10px 0;
    cursor: pointer;
    transition: background-color 0.3s ease;
    text-align: left;
    color: #ffffff;
    background-color: #3498db;
}

.action-button:hover, .select-button:hover {
    background-color: #2980b9;
}

.action-button:disabled, .select-button:disabled {
    background-color: #bdc3c7;
    cursor: not-allowed;
}




/* 테이블 스타일 */
table {
    width: 100%;
    table-layout: fixed; /* 고정된 레이아웃을 사용하여 열 너비를 고정 */
    border-collapse: collapse;
    margin-top: 20px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

/* 각 셀 스타일 */
th, td {
    padding: 15px;
    text-align: center; /* 텍스트 가운데 정렬 */
    border-bottom: 1px solid #ddd;
    overflow: hidden; /* 넘치는 텍스트 숨김 */
    white-space: nowrap; /* 텍스트 줄바꿈 방지 */
}

/* 타이틀 이름(헤더) 스타일 */
th {
    background-color: #f8f9fa;
    color: #34495e;
    text-transform: uppercase;
    font-size: 14px;
    letter-spacing: 0.05em;
}

/* 각 열의 개별 너비 설정 */
th:nth-child(1), td:nth-child(1) { /* 구분 */
    width: 10%;
}

th:nth-child(2), td:nth-child(2) { /* 제품 */
    width: 30%;
}

th:nth-child(3), td:nth-child(3) { /* 단가 */
    width: 15%;
}

th:nth-child(4), td:nth-child(4) { /* 수량 */
    width: 10%;
}

th:nth-child(5), td:nth-child(5) { /* 가격 */
    width: 15%;
}

th:nth-child(6), td:nth-child(6) { /* 비고 */
    width: 10%;
}

th:nth-child(7), td:nth-child(7) { /* 작업 */
    width: 10%;
}

/* 입력 필드 스타일 조정 */
td input[type="text"],
td input[type="number"] {
    width: 100%; /* 입력 필드가 셀의 가로 크기에 맞게 설정 */
    box-sizing: border-box; /* 테두리와 패딩을 너비에 포함 */
    padding: 5px; /* 내부 여백 설정 */
}



.form-group {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
}

.form-row {
    width: 100%;
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.form-row > div {
    width: 49%;
}

.form-row .select-button {
    width: 100%;
    margin: 5px 0;
}

#addButton {
    width: 100%;
    margin-top: 10px;
}

#customerName, #quoteDate {
    width: 100%;
    padding: 14px 20px;
    font-size: 16px;
    margin: 5px 0;
    border: 1px solid #bdc3c7;
    border-radius: 8px;
    transition: border-color 0.3s ease;
    box-sizing: border-box;
}

#customerName:focus, #quoteDate:focus {
    outline: none;
    border-color: #3498db;
}

@media (max-width: 768px) {
    .container {
        margin: 10px;
        padding: 15px;
    }

    .form-row {
        flex-direction: column;
    }

    .form-row > div {
        width: 100%;
    }
}

/* 버튼을 가로로 배치하기 위한 스타일 추가 */
.button-container {
    display: flex;
    justify-content: center; /* 가운데 정렬 */
    gap: 10px; /* 버튼 간 간격 */
    margin-top: 20px; /* 버튼 위쪽 여백 */
}

/* 가격 숨김 버튼 스타일 */
#togglePriceButton {
    margin-bottom: 0; /* 기존의 margin-bottom 제거 */
}

        </style>
</head>
<body>
    <div class="container">
        <h1>견적서 작성</h1>

        <div class="form-row">
            <div>
                <label for="quoteDate">견적일자:</label>
                <input type="date" id="quoteDate" name="quoteDate">
            </div>
            <div>
                <label for="customerName">고객 이름:</label>
                <input type="text" id="customerName" name="customerName">
            </div>
        </div>

        <div class="form-group">
            <div class="form-row">
                <div>
                    <select id="companySelect" class="select-button">
                        <option value="">회사 선택</option>
                    </select>
                </div>
                <div>
                    <select id="productSelect" class="select-button" disabled>
                        <option value="">제품 선택</option>
                    </select>
                </div>
            </div>
            <button id="addButton" class="action-button" disabled>추가</button>
        </div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th>구분</th>
                    <th>제품</th>
                    <th>단가</th>
                    <th>수량</th>
                    <th>가격</th>
                    <th>비고</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button id="togglePriceButton" class="action-button">가격 숨기기</button>
        <button id="exportExcelButton" class="action-button">엑셀로 내보내기</button>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        let inquryWorkbook;
        let companies = {};
        let productCount = 0;
        let pricesHidden = false;
    
        async function init() {
            try {
                // product 파일 로드
                const productResponse = await fetch('/local/path/to/product.xlsx');
                const productArrayBuffer = await productResponse.arrayBuffer();
                const productWorkbook = new ExcelJS.Workbook();
                await productWorkbook.xlsx.load(productArrayBuffer);

                productWorkbook.eachSheet((worksheet, sheetId) => {
                    const companyName = worksheet.name;
                    companies[companyName] = {};

                    worksheet.eachRow((row, rowNumber) => {
                        if (rowNumber > 1) {
                            const product = row.getCell(1).value;
                            const price = row.getCell(2).value;
                            companies[companyName][product] = price;
                        }
                    });
                });

                const companySelect = document.getElementById('companySelect');
                for (let company in companies) {
                    const option = document.createElement('option');
                    option.value = company;
                    option.textContent = company;
                    companySelect.appendChild(option);
                }

                // inqury 파일 로드 (기존 로직)
                const inquryResponse = await fetch('/inqury.xlsx');
                const inquryArrayBuffer = await inquryResponse.arrayBuffer();
                inquryWorkbook = new ExcelJS.Workbook();
                await inquryWorkbook.xlsx.load(inquryArrayBuffer);

                console.log("초기화 완료");
            } catch (error) {
                console.error('초기화 중 오류 발생:', error);
                alert('데이터 로드 중 오류가 발생했습니다.');
            }
        }

    
        document.getElementById('companySelect').addEventListener('change', handleCompanyChange);
        document.getElementById('productSelect').addEventListener('change', handleProductChange);
        document.getElementById('addButton').addEventListener('click', addTableRow);
        document.getElementById('exportExcelButton').addEventListener('click', exportToExcel);
        document.getElementById('togglePriceButton').addEventListener('click', togglePrices);
    
        function handleCompanyChange() {
            const companySelect = document.getElementById('companySelect');
            const productSelect = document.getElementById('productSelect');
            const selectedCompany = companySelect.value;
    
            productSelect.innerHTML = '<option value="">제품 선택</option>';
            if (selectedCompany) {
                for (let product in companies[selectedCompany]) {
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    productSelect.appendChild(option);
                }
                productSelect.disabled = false;
            } else {
                productSelect.disabled = true;
            }
            document.getElementById('addButton').disabled = true;
        }
    
        function handleProductChange() {
            const productSelect = document.getElementById('productSelect');
            const addButton = document.getElementById('addButton');
    
            if (productSelect.value) {
                addButton.disabled = false;
            } else {
                addButton.disabled = true;
            }
        }
    
        function addTableRow() {
            const product = document.getElementById('productSelect').value;
            const unitPrice = companies[document.getElementById('companySelect').value][product];
    
            const tableBody = document.querySelector('#dataTable tbody');
            const newRow = tableBody.insertRow();
    
            // 구분 번호 추가
            const indexCell = newRow.insertCell(0);
            indexCell.textContent = ++productCount;
    
            // 제품명
            newRow.insertCell(1).textContent = product;
    
            // 단가
            const unitPriceCell = newRow.insertCell(2);
            const unitPriceInput = document.createElement('input');
            unitPriceInput.type = 'text'; // 텍스트 타입으로 변경
            unitPriceInput.value = formatNumber(unitPrice); // 포맷된 초기 값
            unitPriceInput.className = 'price-cell';
            unitPriceInput.oninput = function() {
                this.value = formatNumber(this.value.replace(/,/g, '')); // 입력 시마다 쉼표 포맷팅
                updatePriceFromUnitPrice(newRow);
            };
            unitPriceCell.appendChild(unitPriceInput);
    
            // 수량 입력 필드 추가
            const quantityCell = newRow.insertCell(3);
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.min = '0';
            quantityInput.value = '1';
            quantityInput.oninput = function() {
                updatePriceFromUnitPrice(newRow);
            };
            quantityCell.appendChild(quantityInput);
    
            // 가격 (수량에 따른 가격)
            const priceCell = newRow.insertCell(4);
            const priceInput = document.createElement('input');
            priceInput.type = 'text'; // 텍스트 타입으로 변경하여 포맷팅 적용
            priceInput.value = formatNumber(unitPrice * quantityInput.value); // 포맷된 초기 값
            priceInput.className = 'price-cell';
            priceInput.readOnly = true; // 가격 필드를 읽기 전용으로 설정
            priceCell.appendChild(priceInput);
    
            // 비고 입력 필드 추가
            const noteCell = newRow.insertCell(5);
            const noteInput = document.createElement('input');
            noteInput.type = 'text';
            noteInput.placeholder = '비고 입력';
            noteCell.appendChild(noteInput);
    
            // 삭제 버튼
            const deleteCell = newRow.insertCell(6);
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '삭제';
            deleteButton.onclick = function() {
                tableBody.removeChild(newRow);
                updateProductCount();
            };
            deleteCell.appendChild(deleteButton);
    
            document.getElementById('productSelect').value = '';
            handleProductChange();
    
            if (pricesHidden) {
                unitPriceInput.disabled = true;
                priceInput.disabled = true;
                unitPriceInput.value = ''; // 숨김
                priceInput.value = ''; // 숨김
            }
        }
    
        function updateProductCount() {
            const rows = document.querySelectorAll('#dataTable tbody tr');
            productCount = 0;
            rows.forEach((row, index) => {
                row.cells[0].textContent = ++productCount;
            });
        }
    
        // 가격 업데이트 함수
        function updatePriceFromUnitPrice(row) {
            const unitPrice = parseFloat(row.cells[2].querySelector('input').value.replace(/,/g, '')) || 0; // 쉼표 제거 후 숫자로 변환
            const quantity = parseInt(row.cells[3].querySelector('input').value) || 0;
            const priceInput = row.cells[4].querySelector('input');
    
            const totalPrice = unitPrice * quantity; // 총 가격 계산
            priceInput.value = formatNumber(totalPrice); // 천 단위로 포맷팅하여 표시
        }
    
        // 천 단위 쉼표를 추가하고 소수점 없이 정수로 표시하는 함수
        function formatNumber(number) {
            if (!number) return ''; // 빈 값 처리
            return Math.round(number).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); // 소수점 제거 후 천 단위로 쉼표 추가
        }
    
        function togglePrices() {
            const unitPriceElements = document.querySelectorAll('td:nth-child(3) input'); // 단가 입력 필드를 선택
            const priceElements = document.querySelectorAll('td:nth-child(5) input'); // 가격 입력 필드를 선택
            const button = document.getElementById('togglePriceButton');
    
            pricesHidden = !pricesHidden;
    
            // 모든 단가 및 가격 필드를 잠금 또는 해제
            unitPriceElements.forEach(element => {
                if (pricesHidden) {
                    element.setAttribute('data-current-value', element.value); // 현재 값을 저장
                    element.disabled = true;
                    element.value = ''; // 내용 숨기기
                    element.style.backgroundColor = '#e9ecef'; // 비활성화된 스타일
                    element.style.color = '#e9ecef'; // 텍스트 색상도 배경과 같게 설정하여 숨김
                } else {
                    element.disabled = false;
                    element.value = element.getAttribute('data-current-value'); // 저장된 값을 복원
                    element.style.backgroundColor = ''; // 원래 스타일로 복원
                    element.style.color = ''; // 원래 텍스트 색상 복원
                }
            });
    
            priceElements.forEach(element => {
                if (pricesHidden) {
                    element.setAttribute('data-current-value', element.value); // 현재 값을 저장
                    element.disabled = true;
                    element.value = ''; // 내용 숨기기
                    element.style.backgroundColor = '#e9ecef'; // 비활성화된 스타일
                    element.style.color = '#e9ecef'; // 텍스트 색상도 배경과 같게 설정하여 숨김
                } else {
                    element.disabled = false;
                    element.value = element.getAttribute('data-current-value'); // 저장된 값을 복원
                    element.style.backgroundColor = ''; // 원래 스타일로 복원
                    element.style.color = ''; // 원래 텍스트 색상 복원
                }
            });
    
            button.textContent = pricesHidden ? '가격 보이기' : '가격 숨기기';
        }



        async function exportToExcel() {
    try {
        const response = await fetch('/inqury.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(arrayBuffer);

        const worksheet = workbook.getWorksheet(1);
        const tableRows = document.querySelectorAll('#dataTable tbody tr');
        const startRow = 18;
        const endRow = 150;

        // 원본 워크시트의 열 너비를 정확히 복사
        worksheet.columns.forEach((column, index) => {
            const col = worksheet.getColumn(index + 1);
            if (col.width) {
                column.width = col.width;
            }
        });

        const quoteDate = document.getElementById('quoteDate').value;
        worksheet.getCell('A3').value = quoteDate;

        const customerName = document.getElementById('customerName').value;
        worksheet.getCell('A4').value = customerName;

        let totalAmount = 0;

        tableRows.forEach((row, index) => {
            const rowIndex = startRow + index;

            worksheet.getCell(`A${rowIndex}`).value = index + 1;
            worksheet.getCell(`C${rowIndex}`).value = row.cells[1].textContent;

            if (!pricesHidden) {
                // 쉼표를 제거하고 숫자로 변환하여 Excel에 기록
                const unitPrice = parseFloat(row.cells[2].querySelector('input').value.replace(/,/g, '')) || 0;
                const price = parseFloat(row.cells[4].querySelector('input').value.replace(/,/g, '')) || 0;

                worksheet.getCell(`F${rowIndex}`).value = unitPrice;
                worksheet.getCell(`I${rowIndex}`).value = price;

                totalAmount += price;
            } else {
                worksheet.getCell(`F${rowIndex}`).value = " ";
                worksheet.getCell(`I${rowIndex}`).value = " ";
            }

            worksheet.getCell(`H${rowIndex}`).value = parseInt(row.cells[3].querySelector('input').value) || 0;
            worksheet.getCell(`K${rowIndex}`).value = row.cells[5].querySelector('input').value;

            ['A', 'C', 'F', 'H', 'I', 'K'].forEach(col => {
                worksheet.getCell(`${col}${rowIndex}`).alignment = { vertical: 'middle', horizontal: 'center' };
            });
        });

        if (!pricesHidden) {
            const vat = totalAmount * 0.1; // 부가세 10% 계산
            worksheet.getCell('F12').value = totalAmount; // F12 셀에 총 금액 기록
            worksheet.getCell('F12').alignment = { vertical: 'middle', horizontal: 'center' };

            worksheet.getCell('F11').value = totalAmount + vat; // F11 셀에 부가세 포함 총 금액 기록
            worksheet.getCell('F11').alignment = { vertical: 'middle', horizontal: 'center' };
        } else {
            worksheet.getCell('F11').value = " ";
            worksheet.getCell('F12').value = " ";
        }

        let rowsToDelete = [];
        for (let i = startRow; i <= endRow; i++) {
            const checkCell = worksheet.getCell(`A${i}`);
            if (checkCell.value === null || checkCell.value.toString().toLowerCase() === 'null') {
                rowsToDelete.push(i);
            }
        }

        rowsToDelete.reverse().forEach(rowNumber => {
            worksheet.spliceRows(rowNumber, 1);
        });

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = '견적서_' + quoteDate + '.xlsx';
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('엑셀 파일 생성 중 오류 발생:', error);
        alert('엑셀 파일 생성에 실패했습니다.');
    }
}



    window.onload = init;
</script>
</script>
</body>
</html>