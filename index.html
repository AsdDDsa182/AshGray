<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <title>견적서 작성</title>
<style>
    body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f7fa;
        color: #333;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }

    .container {
        width: 100%;
        max-width: 1000px;
        padding: 30px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        text-align: center;
        margin: 20px;
    }

    h1 {
        font-size: 28px;
        color: #2c3e50;
        margin-bottom: 30px;
    }

    .action-button, .select-button {
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        color: #ffffff;
        background-color: #3498db;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .action-button:hover, .select-button:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .action-button:disabled, .select-button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .custom-select {
        position: relative;
        width: 100%;
        margin-bottom: 15px;
    }

    .select-button {
        width: 100%;
        padding: 12px 20px;
        font-size: 16px;
        text-align: left;
        position: relative;
    }

    .select-button:after {
        content: '\25BC';
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        font-size: 12px;
    }

    .select-options {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 999;
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .select-options div {
        padding: 12px 20px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .select-options div:hover {
        background-color: #f0f0f0;
    }

    .table-container {
        width: 100%;
        overflow-x: auto;
        margin-top: 30px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        min-width: 800px;
        border-collapse: separate;
        border-spacing: 0;
    }

    th, td {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #e0e0e0;
    }

    th {
        background-color: #f8f9fa;
        color: #2c3e50;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 14px;
        letter-spacing: 0.05em;
    }

    tr:last-child td {
        border-bottom: none;
    }

    th:first-child, td:first-child {
        border-left: 1px solid #e0e0e0;
    }

    th:last-child, td:last-child {
        border-right: 1px solid #e0e0e0;
    }

    th:nth-child(1), td:nth-child(1) { width: 10%; }
    th:nth-child(2), td:nth-child(2) { width: 30%; }
    th:nth-child(3), td:nth-child(3) { width: 15%; }
    th:nth-child(4), td:nth-child(4) { width: 10%; }
    th:nth-child(5), td:nth-child(5) { width: 15%; }
    th:nth-child(6), td:nth-child(6) { width: 10%; }
    th:nth-child(7), td:nth-child(7) { width: 10%; }

    td input[type="text"],
    td input[type="number"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }

    td input[type="text"]:focus,
    td input[type="number"]:focus {
        outline: none;
        border-color: #3498db;
    }

    .form-group {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .form-row {
        width: 100%;
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .form-row > div {
        width: 48%;
    }

    .form-row label {
        display: block;
        text-align: left;
        margin-bottom: 5px;
        font-weight: 600;
        color: #2c3e50;
    }

    #addButton {
        width: 100%;
        margin-top: 15px;
    }



    .button-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
    }

    #togglePriceButton, #exportExcelButton {
        min-width: 150px;
    }

    /* 견적 연도, 월, 일 및 고객 이름 입력 필드 스타일 */
.form-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.form-row > div {
    flex: 1;
    margin-right: 10px;
}

.form-row > div:last-child {
    margin-right: 0;
}

.form-row label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

#quoteYear,
#quoteMonth,
#quoteDay {
    width: 30%;
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 14px;
    margin-right: 5px;
    background-color: #f9f9f9;
    color: #2c3e50;
    transition: border-color 0.3s ease;
}

#quoteYear:focus,
#quoteMonth:focus,
#quoteDay:focus {
    outline: none;
    border-color: #3498db;
    background-color: #ffffff;
}

#customerName {
    width: 100%;
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 14px;
    background-color: #f9f9f9;
    transition: border-color 0.3s ease;
}

#customerName:focus {
    outline: none;
    border-color: #3498db;
    background-color: #ffffff;
}



@media (max-width: 768px) {
    .container {
        margin: 10px;
        padding: 20px;
    }

    .form-row {
        flex-direction: column;
    }

    .form-row > div {
        width: 100%;
        margin-bottom: 10px;
    }

    .button-container {
        flex-direction: column;
    }

    #togglePriceButton, #exportExcelButton {
        width: 100%;
    }
}

/* 견적일자와 고객 이름 입력 필드 개선 */
.input-group {
    position: relative;
    margin-bottom: 20px;
}

.input-group label {
    position: absolute;
    top: -10px;
    left: 10px;
    background-color: #ffffff;
    padding: 0 5px;
    font-size: 14px;
    color: #3498db;
    transition: all 0.3s ease;
}

.input-group input {
    width: 100%;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    transition: all 0.3s ease;
}

.input-group input:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.input-group input:focus + label,
.input-group input:not(:placeholder-shown) + label {
    top: -25px;
    left: 5px;
    font-size: 12px;
    color: #2c3e50;
}

/* 테이블 내 입력 필드 개선 */
td input[type="text"],
td input[type="number"] {
    border: none;
    background-color: transparent;
    font-size: 14px;
    text-align: center;
    width: 100%;
    padding: 5px;
    transition: all 0.3s ease;
}

td input[type="text"]:focus,
td input[type="number"]:focus {
    background-color: #f0f8ff;
    outline: none;
}

/* 삭제 버튼 스타일 */
.delete-button {
    background-color: #e74c3c;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.delete-button:hover {
    background-color: #c0392b;
}

/* 스크롤바 스타일 */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 5px;
}

::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>

</head>
<body>
    <div class="container">
        <h1>견적서 작성</h1>

        <div class="form-row">
            <div>
                <label for="quoteYear">견적 연도:</label>
                <select id="quoteYear" name="quoteYear"></select>
                <select id="quoteMonth" name="quoteMonth"></select>
                <select id="quoteDay" name="quoteDay"></select>
            </div>
            <div>
                <label for="customerName">고객 이름:</label>
                <input type="text" id="customerName" name="customerName">
            </div>
        </div>
    
        <div class="form-group">
            <div class="custom-select">
                <button class="select-button" id="companySelectButton">회사 선택</button>
                <div class="select-options" id="companyOptions">
                    <!-- 기본 상태로 되돌리는 버튼 추가 -->
                    <div onclick="resetCompanySelection()" style="opacity: 0.4;">- 회사 선택 -</div>

                </div>
            </div>
            <div class="custom-select">
                <button class="select-button" id="productSelectButton" disabled>제품 선택</button>
                <div class="select-options" id="productOptions">
                    <!-- 기본 상태로 되돌리는 버튼 추가 -->
                    <div onclick="resetCompanySelection()" style="opacity: 0.4;">- 제품 선택 -</div>

                </div>
            </div>
            
            <button id="addButton" class="action-button" disabled>추가</button>
        </div>
    
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>구분</th>
                        <th>제품</th>
                        <th>단가</th>
                        <th>수량</th>
                        <th>가격</th>
                        <th>비고</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    
        <div class="button-container">
            <button id="togglePriceButton" class="action-button">가격 숨기기</button>
            <button id="exportExcelButton" class="action-button">엑셀로 내보내기</button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        let inquryWorkbook;
        let companies = {};
        let productCount = 0;
        let pricesHidden = false;
        let selectedCompany = '';
        let selectedProduct = '';

        // 연도, 월, 일 드롭다운 초기화 함수
        function initDateFields() {
            const yearSelect = document.getElementById('quoteYear');
            const monthSelect = document.getElementById('quoteMonth');
            const daySelect = document.getElementById('quoteDay');

            // 현재 연도 구하기
            const currentYear = new Date().getFullYear();

            // 연도 드롭다운 초기화 (현재 연도부터 100년 전까지)
            for (let year = currentYear; year >= currentYear - 100; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            // 월 드롭다운 초기화
            for (let month = 1; month <= 12; month++) {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthSelect.appendChild(option);
            }

            // 일 드롭다운 초기화
            updateDayOptions();

            // 월 선택 변경 시 일자 업데이트
            monthSelect.addEventListener('change', updateDayOptions);
            yearSelect.addEventListener('change', updateDayOptions);

            function updateDayOptions() {
                const year = parseInt(yearSelect.value);
                const month = parseInt(monthSelect.value);

                // 해당 연도와 월의 마지막 날짜 구하기
                const daysInMonth = new Date(year, month, 0).getDate();
                daySelect.innerHTML = ''; // 기존 옵션 초기화

                for (let day = 1; day <= daysInMonth; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
            }
        }

        async function init() {
            initDateFields(); // 날짜 입력 필드 초기화

            try {
                const productResponse = await fetch('https://asdddsa182.github.io/AshGray/product.xlsx');
                const productArrayBuffer = await productResponse.arrayBuffer();
                const productWorkbook = new ExcelJS.Workbook();
                await productWorkbook.xlsx.load(productArrayBuffer);

                productWorkbook.eachSheet((worksheet, sheetId) => {
                    const companyName = worksheet.name;
                    companies[companyName] = {};

                    worksheet.eachRow((row, rowNumber) => {
                        if (rowNumber > 1) {
                            const product = row.getCell(1).value;
                            const price = row.getCell(2).value;
                            companies[companyName][product] = price;
                        }
                    });
                });

                const companyOptions = document.getElementById('companyOptions');
                for (let company in companies) {
                    const option = document.createElement('div');
                    option.textContent = company;
                    option.onclick = () => selectCompany(company);
                    companyOptions.appendChild(option);
                }

                const inquryResponse = await fetch('https://asdddsa182.github.io/AshGray/inqury.xlsx');
                const inquryArrayBuffer = await inquryResponse.arrayBuffer();
                inquryWorkbook = new ExcelJS.Workbook();
                await inquryWorkbook.xlsx.load(inquryArrayBuffer);

                console.log("초기화 완료");
            } catch (error) {
                console.error('초기화 중 오류 발생:', error);
                alert('데이터 로드 중 오류가 발생했습니다.');
            }
        }

        document.getElementById('companySelectButton').addEventListener('click', toggleCompanyOptions);
        document.getElementById('productSelectButton').addEventListener('click', toggleProductOptions);
        document.getElementById('addButton').addEventListener('click', addTableRow);
        document.getElementById('exportExcelButton').addEventListener('click', exportToExcel);
        document.getElementById('togglePriceButton').addEventListener('click', togglePrices);

        function toggleCompanyOptions() {
            const companyOptions = document.getElementById('companyOptions');
            const productOptions = document.getElementById('productOptions');
            
            if (companyOptions.style.display === 'block') {
                companyOptions.style.display = 'none';
            } else {
                companyOptions.style.display = 'block';
                productOptions.style.display = 'none';
            }
        }

        function toggleProductOptions() {
            const companyOptions = document.getElementById('companyOptions');
            const productOptions = document.getElementById('productOptions');
            
            if (productOptions.style.display === 'block') {
                productOptions.style.display = 'none';
            } else {
                productOptions.style.display = 'block';
                companyOptions.style.display = 'none';
            }
        }

        function selectCompany(company) {
    selectedCompany = company;
    document.getElementById('companySelectButton').textContent = company;
    document.getElementById('companyOptions').style.display = 'none';
    
    const productOptions = document.getElementById('productOptions');
    productOptions.innerHTML = '<div onclick="resetProductSelection()">제품 선택</div>'; // 기본 상태로 되돌리는 옵션 추가
    for (let product in companies[company]) {
        const option = document.createElement('div');
        option.textContent = product;
        option.onclick = () => selectProduct(product);
        productOptions.appendChild(option);
    }
    
    document.getElementById('productSelectButton').disabled = false;
    document.getElementById('productSelectButton').textContent = '제품 선택';
    selectedProduct = '';
    document.getElementById('addButton').disabled = true;
}

function selectProduct(product) {
    selectedProduct = product;
    document.getElementById('productSelectButton').textContent = product;
    document.getElementById('productOptions').style.display = 'none';
    document.getElementById('addButton').disabled = false;
}

// 회사 선택 초기화
function resetCompanySelection() {
    selectedCompany = '';
    document.getElementById('companySelectButton').textContent = '회사 선택';
    document.getElementById('companyOptions').style.display = 'none';
    document.getElementById('productSelectButton').disabled = true;
    document.getElementById('productSelectButton').textContent = '제품 선택';
    selectedProduct = '';
    document.getElementById('addButton').disabled = true;
}

// 제품 선택 초기화
function resetProductSelection() {
    selectedProduct = '';
    document.getElementById('productSelectButton').textContent = '제품 선택';
    document.getElementById('productOptions').style.display = 'none';
    document.getElementById('addButton').disabled = true;
}

function addTableRow() {
    const unitPrice = companies[selectedCompany][selectedProduct];

    const tableBody = document.querySelector('#dataTable tbody');
    const newRow = tableBody.insertRow();

    const indexCell = newRow.insertCell(0);
    indexCell.textContent = ++productCount;

    newRow.insertCell(1).textContent = selectedProduct;

    const unitPriceCell = newRow.insertCell(2);
    const unitPriceInput = document.createElement('input');
    unitPriceInput.type = 'text';
    unitPriceInput.value = formatNumber(unitPrice);
    unitPriceInput.className = 'price-cell';
    unitPriceInput.oninput = function() {
        this.value = formatNumber(this.value.replace(/,/g, ''));
        updatePriceFromUnitPrice(newRow);
    };
    unitPriceCell.appendChild(unitPriceInput);

    const quantityCell = newRow.insertCell(3);
    const quantityInput = document.createElement('input');
    quantityInput.type = 'number';
    quantityInput.min = '0';
    quantityInput.value = '1';
    quantityInput.oninput = function() {
        updatePriceFromUnitPrice(newRow);
    };
    quantityCell.appendChild(quantityInput);

    const priceCell = newRow.insertCell(4);
    const priceInput = document.createElement('input');
    priceInput.type = 'text';
    priceInput.value = formatNumber(unitPrice * quantityInput.value);
    priceInput.className = 'price-cell';
    priceInput.readOnly = true;
    priceCell.appendChild(priceInput);

    const noteCell = newRow.insertCell(5);
    const noteInput = document.createElement('input');
    noteInput.type = 'text';
    noteInput.placeholder = '비고 입력';
    noteCell.appendChild(noteInput);

    const deleteCell = newRow.insertCell(6);
    const deleteButton = document.createElement('button');
    deleteButton.textContent = '삭제';
    deleteButton.onclick = function() {
        tableBody.removeChild(newRow);
        updateProductCount();
    };
    deleteCell.appendChild(deleteButton);

    document.getElementById('productSelectButton').textContent = '제품 선택';
    selectedProduct = '';
    document.getElementById('addButton').disabled = true;

    if (pricesHidden) {
        unitPriceInput.disabled = true;
        priceInput.disabled = true;
        unitPriceInput.value = '';
        priceInput.value = '';
    }
}


        function updateProductCount() {
            const rows = document.querySelectorAll('#dataTable tbody tr');
            productCount = 0;
            rows.forEach((row, index) => {
                row.cells[0].textContent = ++productCount;
            });
        }

        function updatePriceFromUnitPrice(row) {
            const unitPrice = parseFloat(row.cells[2].querySelector('input').value.replace(/,/g, '')) || 0;
            const quantity = parseInt(row.cells[3].querySelector('input').value) || 0;
            const priceInput = row.cells[4].querySelector('input');

            const totalPrice = unitPrice * quantity;
            priceInput.value = formatNumber(totalPrice);
        }

        function formatNumber(number) {
            if (!number) return '';
            return Math.round(number).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function togglePrices() {
            const unitPriceElements = document.querySelectorAll('td:nth-child(3) input');
            const priceElements = document.querySelectorAll('td:nth-child(5) input');
            const button = document.getElementById('togglePriceButton');

            pricesHidden = !pricesHidden;

            unitPriceElements.forEach(element => {
                if (pricesHidden) {
                    element.setAttribute('data-current-value', element.value);
                    element.disabled = true;
                    element.value = '';
                    element.style.backgroundColor = '#e9ecef';
                    element.style.color = '#e9ecef';
                } else {
                    element.disabled = false;
                    element.value = element.getAttribute('data-current-value');
                    element.style.backgroundColor = '';
                    element.style.color = '';
                }
            });

            priceElements.forEach(element => {
                if (pricesHidden) {
                    element.setAttribute('data-current-value', element.value);
                    element.disabled = true;
                    element.value = '';
                    element.style.backgroundColor = '#e9ecef';
                    element.style.color = '#e9ecef';
                } else {
                    element.disabled = false;
                    element.value = element.getAttribute('data-current-value');
                    element.style.backgroundColor = '';
                    element.style.color = '';
                }
            });

            button.textContent = pricesHidden ? '가격 보이기' : '가격 숨기기';
        }

        async function exportToExcel() {
            try {
                const response = await fetch('/inqury.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(arrayBuffer);

                const worksheet = workbook.getWorksheet(1);
                const tableRows = document.querySelectorAll('#dataTable tbody tr');
                const startRow = 18;
                const endRow = 150;

                worksheet.columns.forEach((column, index) => {
                    const col = worksheet.getColumn(index + 1);
                    if (col.width) {
                        column.width = col.width;
                    }
                });

                const quoteDate = `${document.getElementById('quoteYear').value}-${document.getElementById('quoteMonth').value}-${document.getElementById('quoteDay').value}`;
                worksheet.getCell('A3').value = quoteDate;

                const customerName = document.getElementById('customerName').value;
                worksheet.getCell('A4').value = customerName;

                let totalAmount = 0;

                tableRows.forEach((row, index) => {
                    const rowIndex = startRow + index;

                    worksheet.getCell(`A${rowIndex}`).value = index + 1;
                    worksheet.getCell(`C${rowIndex}`).value = row.cells[1].textContent;

                    if (!pricesHidden) {
                        const unitPrice = parseFloat(row.cells[2].querySelector('input').value.replace(/,/g, '')) || 0;
                        const price = parseFloat(row.cells[4].querySelector('input').value.replace(/,/g, '')) || 0;

                        worksheet.getCell(`F${rowIndex}`).value = unitPrice;
                        worksheet.getCell(`I${rowIndex}`).value = price;

                        totalAmount += price;
                    } else {
                        worksheet.getCell(`F${rowIndex}`).value = " ";
                        worksheet.getCell(`I${rowIndex}`).value = " ";
                    }

                    worksheet.getCell(`H${rowIndex}`).value = parseInt(row.cells[3].querySelector('input').value) || 0;
                    worksheet.getCell(`K${rowIndex}`).value = row.cells[5].querySelector('input').value;

                    ['A', 'C', 'F', 'H', 'I', 'K'].forEach(col => {
                        worksheet.getCell(`${col}${rowIndex}`).alignment = { vertical: 'middle', horizontal: 'center' };
                    });
                });

                if (!pricesHidden) {
                    const vat = totalAmount * 0.1;
                    worksheet.getCell('F12').value = totalAmount;
                    worksheet.getCell('F12').alignment = { vertical: 'middle', horizontal: 'center' };

                    worksheet.getCell('F11').value = totalAmount + vat;
                    worksheet.getCell('F11').alignment = { vertical: 'middle', horizontal: 'center' };
                } else {
                    worksheet.getCell('F11').value = " ";
                    worksheet.getCell('F12').value = " ";
                }

                let rowsToDelete = [];
                for (let i = startRow; i <= endRow; i++) {
                    const checkCell = worksheet.getCell(`A${i}`);
                    if (checkCell.value === null || checkCell.value.toString().toLowerCase() === 'null') {
                        rowsToDelete.push(i);
                    }
                }

                rowsToDelete.reverse().forEach(rowNumber => {
                    worksheet.spliceRows(rowNumber, 1);
                });

                const fileName = `${customerName || '일반'}_고객_견적서.xlsx`;

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('엑셀 파일 생성 중 오류 발생:', error);
                alert('엑셀 파일 생성에 실패했습니다.');
            }
        }
        window.onload = init;
    </script>
</body>
</html>
</antArtifact>
